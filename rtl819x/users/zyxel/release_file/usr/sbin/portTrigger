#!/bin/sh

##check mode,if AP/UR,exit	
#local sys_mode=$(get_sys_mode)
#[ "$sys_mode" == "2" -o "$sys_mode" == "3" ] && exit 0


sys_mode=`flash get OP_MODE | awk -F'=' '{print $2}'`
[ "$sys_mode" == "1" -o "$sys_mode" == "2" ] && exit 0



. /sbin/functions.sh
include /sbin

wan_ifname=
lan_ifname=
wan_ip=
nat_enable=$(uci_get nat general nat)
usage() {
	echo $0 "<command>"
	exit 0
}

reload_portTrigger(){
	
	local trig=$1
	local in_port_start
	local in_port_end
	local tr_port_start
	local tr_port_end
	local in_ports
	local tr_ports

	config_get in_port_start $trig inComing_port_start
	config_get in_port_end $trig inComing_port_end
	config_get tr_port_start $trig trigger_port_start
	config_get tr_port_end $trig trigger_port_end
	
	if [ $in_port_start == $in_port_end ] ; then
		in_ports=$in_port_start	
	else
		in_ports="$in_port_start"-"$in_port_end"
	fi

	if [ $tr_port_start == $tr_port_end ] ; then
		tr_ports="$tr_port_start"
	else
		tr_ports="$tr_port_start"-"$tr_port_end"
	fi

	if [ $in_ports != "0" ] && [ $tr_ports != "0" ] ; then
		iptables -A forwarding_rule_porttrigger -i $lan_ifname -o $wan_ifname -j PORTTRIGGER --mode forward_out --trigger-ports $tr_ports --forward-ports $in_ports
	fi
	
	#iptables -A forwarding_rule_porttrigger -i $wan_ifname -o $lan_ifname -j PORTTRIGGER --mode forward_in
	#iptables -t nat -A prerouting_rule_porttrigger -i $wan_ifname -j PORTTRIGGER --mode dnat
	
	return 0 
}

cmd=$1
shift
case "$cmd" in
	--help|help) usage ;;
	start|stop|reload|restart|init)
		
		iptables -F forwarding_rule_porttrigger 2>/dev/null
		iptables -D FORWARD -j forwarding_rule_porttrigger 2>/dev/null
		iptables -t nat -F prerouting_rule_porttrigger 2>/dev/null
		iptables -t nat -D PREROUTING -j prerouting_rule_porttrigger 2>/dev/null
		iptables -X forwarding_rule_porttrigger 2>/dev/null
		iptables -t nat -X prerouting_rule_porttrigger 2>/dev/null
		
		config_load network
		config_get wan_proto wan proto
		if [ "$wan_proto" == "pppoe" ] || [ "$wan_proto" == "pptp" ];then
			wan_ifname="ppp0"
		else
			config_get wan_ifname wan ifname
		fi
						
		config_get lan_type br0 type
		if [ "$lan_type" == "bridge" ]; then
			lan_ifname="br0"
		else
			config_get lan_ifname br0 ifname	
		fi
				
		wan_ip=$(ifconfig $wan_ifname | egrep -o 'inet addr:[0-9.]*' | grep -o "[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}")
				
		if [ "$nat_enable" == "enable" ];then
			
			iptables -N forwarding_rule_porttrigger
			iptables -t nat -N prerouting_rule_porttrigger
			
			config_load portTrigger
			config_foreach reload_portTrigger trigger
			
			chain_check=`iptables -L forwarding_rule_porttrigger | grep forward_out`			
			
			#if [ ! -z "iptables -L forwarding_rule_porttrigger | grep forward_out" ];then
			if [ ! -z "$chain_check" ];then
				iptables -A forwarding_rule_porttrigger -i $wan_ifname -o $lan_ifname -j PORTTRIGGER --mode forward_in
				iptables -t nat -A prerouting_rule_porttrigger -i $wan_ifname -j PORTTRIGGER --mode dnat
				iptables -t nat -I PREROUTING -j prerouting_rule_porttrigger
			fi
			
		fi
		
		## iptables app reorder
		/usr/sbin/iptables_app_order
		
		exit $?
	;;
esac

exit $?
